# PocketBase æ€§èƒ½åŸºå‡†æµ‹è¯• Makefile

.PHONY: all build test clean run-all run-sqlite run-http run-websocket run-database help

# é»˜è®¤ç›®æ ‡
all: build

# æ„å»º
build:
	@echo "ğŸ”¨ æ„å»ºåŸºå‡†æµ‹è¯•å·¥å…·..."
	@mkdir -p bin reports/comparison reports/cluster reports/sqlite reports/postgresql
	go build -o bin/benchmark ./cmd/benchmark
	go build -o bin/pg-compare ./cmd/pg-compare
	go build -o bin/cluster-benchmark ./cmd/cluster-benchmark
	@echo "âœ… æ„å»ºå®Œæˆ: bin/benchmark, bin/pg-compare, bin/cluster-benchmark"

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
	go test -v -cover ./...

# æ¸…ç†
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºäº§ç‰©å’Œæµ‹è¯•æ•°æ®..."
	rm -rf bin/
	rm -f benchmark.db benchmark.db-wal benchmark.db-shm
	rm -f *.db *.db-wal *.db-shm
	@echo "æ³¨: reports/ ç›®å½•åŒ…å«æµ‹è¯•æŠ¥å‘Šï¼Œä¸ä¼šè¢«æ¸…ç†"

# ä¾èµ–ç®¡ç†
deps:
	@echo "ğŸ“¦ æ›´æ–°ä¾èµ–..."
	go mod tidy

# ============ è¿è¡Œæµ‹è¯• ============

# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
run-all: build
	@echo "ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶..."
	./bin/benchmark -test all -duration 30s -concurrency 10

# SQLite æµ‹è¯•
run-sqlite: build
	@echo "ğŸ“Š è¿è¡Œ SQLite åŸºå‡†æµ‹è¯•..."
	./bin/benchmark -test sqlite -db sqlite -duration 30s

run-sqlite-small: build
	@echo "ğŸ“Š è¿è¡Œ SQLite å°è§„æ¨¡æµ‹è¯•..."
	./bin/benchmark -test sqlite -db sqlite -scale small -duration 15s

run-sqlite-medium: build
	@echo "ğŸ“Š è¿è¡Œ SQLite ä¸­è§„æ¨¡æµ‹è¯•..."
	./bin/benchmark -test sqlite -db sqlite -scale medium -duration 30s

run-sqlite-large: build
	@echo "ğŸ“Š è¿è¡Œ SQLite å¤§è§„æ¨¡æµ‹è¯•..."
	./bin/benchmark -test sqlite -db sqlite -scale large -duration 60s

# PostgreSQL æµ‹è¯•
run-postgres: build
	@echo "ğŸ“Š è¿è¡Œ PostgreSQL åŸºå‡†æµ‹è¯•..."
	./bin/benchmark -test database -db postgresql -duration 30s

# PostgreSQL vs SQLite å¯¹æ¯”æµ‹è¯•
run-pg-compare: build
	@echo "ğŸ“Š è¿è¡Œ PostgreSQL vs SQLite å¯¹æ¯”æµ‹è¯•..."
	./bin/pg-compare -duration 30s -concurrency 10 -scale small -verbose

run-pg-compare-all: build
	@echo "ğŸ“Š è¿è¡Œå®Œæ•´ PostgreSQL ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•..."
	./bin/pg-compare -duration 60s -concurrency 20 -scale medium -verbose

run-pg15: build
	@echo "ğŸ“Š è¿è¡Œ PostgreSQL 15 æµ‹è¯•..."
	./bin/pg-compare -duration 30s -concurrency 10 -pg-versions 15 -skip-sqlite -verbose

run-pg16: build
	@echo "ğŸ“Š è¿è¡Œ PostgreSQL 16 æµ‹è¯•..."
	./bin/pg-compare -duration 30s -concurrency 10 -pg-versions 16 -skip-sqlite -verbose

run-pg17: build
	@echo "ğŸ“Š è¿è¡Œ PostgreSQL 17 æµ‹è¯•..."
	./bin/pg-compare -duration 30s -concurrency 10 -pg-versions 17 -skip-sqlite -verbose

run-pg18: build
	@echo "ğŸ“Š è¿è¡Œ PostgreSQL 18 æµ‹è¯•..."
	./bin/pg-compare -duration 30s -concurrency 10 -pg-versions 18 -skip-sqlite -verbose

# ============ é›†ç¾¤æµ‹è¯• ============

# 2 èŠ‚ç‚¹é›†ç¾¤æµ‹è¯• (1ä¸»1ä»)
run-cluster-2node: build
	@echo "ğŸ“Š è¿è¡Œ 2 èŠ‚ç‚¹é›†ç¾¤æµ‹è¯•..."
	./bin/cluster-benchmark -duration 30s -concurrency 20 \
		-primary-host localhost -primary-port 5440 \
		-replica-hosts localhost -replica-ports 5441 \
		-password pocketbase_test_password -verbose

# 3 èŠ‚ç‚¹é›†ç¾¤æµ‹è¯• (1ä¸»2ä»)
run-cluster-3node: build
	@echo "ğŸ“Š è¿è¡Œ 3 èŠ‚ç‚¹é›†ç¾¤æµ‹è¯•..."
	./bin/cluster-benchmark -duration 30s -concurrency 30 \
		-primary-host localhost -primary-port 5440 \
		-replica-hosts localhost,localhost -replica-ports 5441,5442 \
		-password pocketbase_test_password -verbose

# HAProxy è´Ÿè½½å‡è¡¡æµ‹è¯•
run-cluster-haproxy: build
	@echo "ğŸ“Š è¿è¡Œ HAProxy è´Ÿè½½å‡è¡¡æµ‹è¯•..."
	./bin/cluster-benchmark -duration 30s -concurrency 50 \
		-primary-host localhost -primary-port 5440 \
		-replica-hosts localhost -replica-ports 5441 \
		-haproxy-host localhost -haproxy-write 5450 -haproxy-read 5451 \
		-password pocketbase_test_password -use-haproxy -verbose

# é›†ç¾¤æ‰©å±•æ€§æµ‹è¯• (å¯¹æ¯” 1/2/3 èŠ‚ç‚¹)
run-cluster-scalability: build
	@echo "ğŸ“Š è¿è¡Œé›†ç¾¤æ‰©å±•æ€§æµ‹è¯•..."
	@echo "=== å•èŠ‚ç‚¹åŸºå‡† ==="
	./bin/pg-compare -duration 20s -concurrency 20 -pg-versions 17 -skip-sqlite -pg-password pocketbase_test_password
	@echo ""
	@echo "=== 2 èŠ‚ç‚¹é›†ç¾¤ ==="
	./bin/cluster-benchmark -duration 20s -concurrency 20 \
		-primary-host localhost -primary-port 5440 \
		-replica-hosts localhost -replica-ports 5441 \
		-password pocketbase_test_password
	@echo ""
	@echo "=== 3 èŠ‚ç‚¹é›†ç¾¤ ==="
	./bin/cluster-benchmark -duration 20s -concurrency 30 \
		-primary-host localhost -primary-port 5440 \
		-replica-hosts localhost,localhost -replica-ports 5441,5442 \
		-password pocketbase_test_password

# HTTP æµ‹è¯•
run-http: build
	@echo "ğŸŒ è¿è¡Œ HTTP API æµ‹è¯•..."
	./bin/benchmark -test http -duration 30s -concurrency 10

# WebSocket æµ‹è¯•
run-websocket: build
	@echo "ğŸ”Œ è¿è¡Œ WebSocket æµ‹è¯•..."
	./bin/benchmark -test websocket -duration 30s -concurrency 50

# æ•°æ®åº“ç›´è¿æµ‹è¯•
run-database: build
	@echo "ğŸ“Š è¿è¡Œæ•°æ®åº“ç›´è¿æµ‹è¯•..."
	./bin/benchmark -test database -duration 30s

# ============ é…ç½®æ–‡ä»¶è¿è¡Œ ============

run-config: build
	@echo "ğŸ“‹ ä½¿ç”¨é…ç½®æ–‡ä»¶è¿è¡Œæµ‹è¯•..."
	@if [ -z "$(CONFIG)" ]; then \
		echo "âŒ è¯·æŒ‡å®šé…ç½®æ–‡ä»¶: make run-config CONFIG=configs/local-sqlite.json"; \
		exit 1; \
	fi
	./bin/benchmark -config $(CONFIG)

run-local-sqlite: build
	./bin/benchmark -config configs/local-sqlite.json

run-local-postgres: build
	./bin/benchmark -config configs/local-postgres.json

run-docker-postgres: build
	./bin/benchmark -config configs/docker-postgres.json

# ============ æŠ¥å‘Šç”Ÿæˆ ============

report:
	@echo "ğŸ“„ ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
	@if [ -z "$(INPUT)" ]; then \
		echo "âŒ è¯·æŒ‡å®šè¾“å…¥æ–‡ä»¶: make report INPUT=results/report.json"; \
		exit 1; \
	fi
	./bin/benchmark -generate-report $(INPUT)

# ============ å¸®åŠ© ============

help:
	@echo ""
	@echo "PocketBase æ€§èƒ½åŸºå‡†æµ‹è¯•å·¥å…·"
	@echo ""
	@echo "ç”¨æ³•: make <target>"
	@echo ""
	@echo "æ„å»ºå’Œæµ‹è¯•:"
	@echo "  build              æ„å»ºåŸºå‡†æµ‹è¯•å·¥å…·"
	@echo "  test               è¿è¡Œå•å…ƒæµ‹è¯•"
	@echo "  clean              æ¸…ç†æ„å»ºäº§ç‰©"
	@echo "  deps               æ›´æ–°ä¾èµ–"
	@echo ""
	@echo "SQLite æµ‹è¯•:"
	@echo "  run-sqlite         è¿è¡Œ SQLite åŸºå‡†æµ‹è¯•"
	@echo "  run-sqlite-small   è¿è¡Œ SQLite å°è§„æ¨¡æµ‹è¯•"
	@echo "  run-sqlite-medium  è¿è¡Œ SQLite ä¸­è§„æ¨¡æµ‹è¯•"
	@echo "  run-sqlite-large   è¿è¡Œ SQLite å¤§è§„æ¨¡æµ‹è¯•"
	@echo ""
	@echo "PostgreSQL æµ‹è¯•:"
	@echo "  run-postgres       è¿è¡Œ PostgreSQL åŸºå‡†æµ‹è¯•"
	@echo "  run-pg-compare     PostgreSQL vs SQLite å¯¹æ¯”æµ‹è¯•"
	@echo "  run-pg-compare-all å®Œæ•´ PostgreSQL ç‰ˆæœ¬å¯¹æ¯”æµ‹è¯•"
	@echo "  run-pg15           è¿è¡Œ PostgreSQL 15 æµ‹è¯•"
	@echo "  run-pg16           è¿è¡Œ PostgreSQL 16 æµ‹è¯•"
	@echo "  run-pg17           è¿è¡Œ PostgreSQL 17 æµ‹è¯•"
	@echo "  run-pg18           è¿è¡Œ PostgreSQL 18 æµ‹è¯•"
	@echo ""
	@echo "PostgreSQL é›†ç¾¤æµ‹è¯•:"
	@echo "  run-cluster-2node      2 èŠ‚ç‚¹é›†ç¾¤æµ‹è¯• (1ä¸»1ä»)"
	@echo "  run-cluster-3node      3 èŠ‚ç‚¹é›†ç¾¤æµ‹è¯• (1ä¸»2ä»)"
	@echo "  run-cluster-haproxy    HAProxy è´Ÿè½½å‡è¡¡æµ‹è¯•"
	@echo "  run-cluster-scalability é›†ç¾¤æ‰©å±•æ€§å¯¹æ¯”æµ‹è¯•"
	@echo ""
	@echo "å…¶ä»–æµ‹è¯•:"
	@echo "  run-all            è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶"
	@echo "  run-http           è¿è¡Œ HTTP API æµ‹è¯•"
	@echo "  run-websocket      è¿è¡Œ WebSocket æµ‹è¯•"
	@echo "  run-database       è¿è¡Œæ•°æ®åº“ç›´è¿æµ‹è¯•"
	@echo ""
	@echo "é…ç½®æ–‡ä»¶è¿è¡Œ:"
	@echo "  run-config CONFIG=<file>  ä½¿ç”¨é…ç½®æ–‡ä»¶è¿è¡Œ"
	@echo "  run-local-sqlite          ä½¿ç”¨æœ¬åœ° SQLite é…ç½®"
	@echo "  run-local-postgres        ä½¿ç”¨æœ¬åœ° PostgreSQL é…ç½®"
	@echo "  run-docker-postgres       ä½¿ç”¨ Docker PostgreSQL é…ç½®"
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make build"
	@echo "  make run-sqlite-small"
	@echo "  make run-pg-compare"
	@echo "  make run-cluster-2node"
	@echo "  make run-config CONFIG=configs/production.json"
	@echo ""
