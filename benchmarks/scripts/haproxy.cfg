# HAProxy 配置 - PostgreSQL 读写分离
# 写入请求路由到主节点，读取请求负载均衡到从节点

global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    option redispatch
    retries 3
    timeout connect 10s
    timeout client 30s
    timeout server 30s
    timeout check 5s

# 统计页面
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# 写入端口 - 路由到主节点
frontend pg_write
    bind *:5432
    default_backend pg_primary

backend pg_primary
    option pgsql-check user pocketbase
    server primary 172.21.0.10:5432 check port 5432 inter 5s fall 3 rise 2

# 读取端口 - 负载均衡到从节点
frontend pg_read
    bind *:5433
    default_backend pg_replicas

backend pg_replicas
    balance roundrobin
    option pgsql-check user pocketbase
    server replica1 172.21.0.11:5432 check port 5432 inter 5s fall 3 rise 2
    server replica2 172.21.0.12:5432 check port 5432 inter 5s fall 3 rise 2 backup
    server replica3 172.21.0.13:5432 check port 5432 inter 5s fall 3 rise 2 backup
    server replica4 172.21.0.14:5432 check port 5432 inter 5s fall 3 rise 2 backup

# 所有节点 (用于故障转移测试)
frontend pg_all
    bind *:5434
    default_backend pg_all_nodes

backend pg_all_nodes
    balance roundrobin
    option pgsql-check user pocketbase
    server primary 172.21.0.10:5432 check port 5432 inter 5s fall 3 rise 2
    server replica1 172.21.0.11:5432 check port 5432 inter 5s fall 3 rise 2
    server replica2 172.21.0.12:5432 check port 5432 inter 5s fall 3 rise 2 backup
