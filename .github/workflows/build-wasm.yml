name: Build Serverless WASM

on:
  push:
    branches:
      - master
      - master-postgresql-new
    paths:
      - 'plugins/serverless/runtime/wasm/quickjs-src/**'
  pull_request:
    branches:
      - master
      - master-postgresql-new
    paths:
      - 'plugins/serverless/runtime/wasm/quickjs-src/**'
  workflow_dispatch: # 允许手动触发

jobs:
  build-wasm:
    name: Build QuickJS WASM
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2
        with:
          version: 0.13.0

      - name: Verify Zig Installation
        run: zig version

      - name: Download QuickJS Source
        working-directory: plugins/serverless/runtime/wasm/quickjs-src
        run: ./build.sh fetch

      - name: Build WASM
        working-directory: plugins/serverless/runtime/wasm/quickjs-src
        run: ./build.sh

      - name: Verify WASM Output
        run: |
          ls -lh plugins/serverless/runtime/wasm/pb_runtime.wasm
          file plugins/serverless/runtime/wasm/pb_runtime.wasm

      - name: Upload WASM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: pb_runtime.wasm
          path: plugins/serverless/runtime/wasm/pb_runtime.wasm
          retention-days: 30

  # 可选: 测试 WASM 是否可以被 Go 加载
  test-wasm-integration:
    name: Test WASM Integration
    runs-on: ubuntu-latest
    needs: build-wasm
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23.0'

      - name: Download WASM Artifact
        uses: actions/download-artifact@v4
        with:
          name: pb_runtime.wasm
          path: plugins/serverless/runtime/wasm/

      - name: Run Serverless Tests
        run: |
          go test ./plugins/serverless/... -v -race -timeout 5m -run "TestEmbed|TestRuntime"
        continue-on-error: true # WASM 测试可能需要特殊环境
