name: Tests

on:
  pull_request:
    branches:
      - master
      - master-postgresql-new
  push:
    branches:
      - master
      - master-postgresql-new

jobs:
  # SQLite 测试 (默认)
  test-sqlite:
    name: Test (SQLite)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23.0'

      - name: Run SQLite Tests
        run: go test ./... -v -race -timeout 10m
        env:
          DB_TYPE: sqlite

  # PostgreSQL 15 测试
  test-postgres-15:
    name: Test (PostgreSQL 15)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pocketbase_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23.0'

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Install PostgreSQL extensions
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d pocketbase_test -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"
        env:
          PGPASSWORD: postgres

      - name: Run PostgreSQL Tests
        run: |
          go test ./tests/... -v -race -timeout 15m -run "TestPostgres"
          go test ./tools/dbutils/... -v -race -timeout 5m
          go test ./core/... -v -race -timeout 10m -run "TestIsolation|TestRetry|TestLock|TestGIN|TestRecordFieldResolverPostgres|TestCollectionCrossQueryPostgres|TestMultiMatchQueryPostgres"
        env:
          DB_TYPE: postgres
          POSTGRES_DSN: postgres://postgres:postgres@localhost:5432/pocketbase_test?sslmode=disable
          TEST_POSTGRES: "1"

  # PostgreSQL 16 测试
  test-postgres-16:
    name: Test (PostgreSQL 16)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: pocketbase_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23.0'

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Install PostgreSQL extensions
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d pocketbase_test -c "CREATE EXTENSION IF NOT EXISTS pg_trgm;"

      - name: Run PostgreSQL Tests
        run: |
          go test ./tests/... -v -race -timeout 15m -run "TestPostgres"
          go test ./tools/dbutils/... -v -race -timeout 5m
          go test ./core/... -v -race -timeout 10m -run "TestIsolation|TestRetry|TestLock|TestGIN|TestRecordFieldResolverPostgres|TestCollectionCrossQueryPostgres|TestMultiMatchQueryPostgres"
        env:
          DB_TYPE: postgres
          POSTGRES_DSN: postgres://postgres:postgres@localhost:5432/pocketbase_test?sslmode=disable
          TEST_POSTGRES: "1"

  # Lint 检查
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.23.0'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: -c ./golangci.yml ./...

  # 汇总测试结果
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-sqlite, test-postgres-15, test-postgres-16, lint]
    if: always()
    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.test-sqlite.result }}" == "failure" ]; then
            echo "SQLite tests failed"
            exit 1
          fi
          if [ "${{ needs.test-postgres-15.result }}" == "failure" ]; then
            echo "PostgreSQL 15 tests failed"
            exit 1
          fi
          if [ "${{ needs.test-postgres-16.result }}" == "failure" ]; then
            echo "PostgreSQL 16 tests failed"
            exit 1
          fi
          if [ "${{ needs.lint.result }}" == "failure" ]; then
            echo "Lint failed"
            exit 1
          fi
          echo "All tests passed!"
