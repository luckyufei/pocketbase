# PocketBase PostgreSQL 演进规范

> **项目代号**: Hangar (机库)
> **愿景**: 保留 PocketBase 的极致开发体验，通过 PostgreSQL 赋予其企业级上限
> **架构哲学**: Simple, Linear, Deep

## 1. 项目概述

### 1.1 背景

PocketBase 基于 SQLite 的架构在以下场景存在瓶颈：
- **高并发写入**: SQLite 的"单写多读"模式无法支撑企业级负载
- **水平扩展**: 无法多实例部署，Hook 触发不确定
- **高级特性**: 缺乏向量搜索、地理空间查询等能力

### 1.2 目标

构建一个"超级单体"架构：
- 保持 PocketBase 单体应用的极简体验
- 融合 Supabase 的关键技术优势 (RLS、实时 WAL 订阅、扩展生态)
- 支持水平扩展和 AI 原生特性

### 1.3 核心价值

| 维度 | SQLite (原版) | PostgreSQL (Hangar) |
|------|--------------|---------------------|
| 并发模型 | 单写多读 | MVCC 高并发读写 |
| 扩展性 | 单机限制 | 水平扩展 + 扩展生态 |
| 实时能力 | API 触发 | WAL 订阅 (全量捕获) |
| 安全模型 | 应用层 Rules | 数据库级 RLS |
| AI 能力 | 无 | pgvector 向量搜索 |

---

## 2. 架构决策记录 (ADR)

### ADR-001: 数据库驱动选择
- **决策**: 使用 `jackc/pgx` 作为 PostgreSQL 驱动
- **理由**: 原生支持 `LISTEN/NOTIFY`、连接池、逻辑复制

### ADR-002: 日志系统设计
- **决策**: 使用 `UNLOGGED TABLE` + 分区表 + 批量写入
- **理由**: 避免 WAL 开销，支持高效清理，不影响核心业务

### ADR-003: 监控系统设计
- **决策**: 独立 Schema (`monitoring`) + BRIN 索引 + 内存预聚合
- **理由**: 逻辑隔离，时序数据优化，降低写入频率

### ADR-004: 分布式事件
- **决策**: 基于 PostgreSQL `LISTEN/NOTIFY` 实现
- **理由**: 零外部依赖，符合单体哲学

### ADR-005: 备份策略
- **决策**: 集成 `pg_dump`，砍掉 UI 恢复功能
- **理由**: 生产环境恢复应通过运维流程

---

## 3. 技术约束

### 3.1 必须保持兼容
- PocketBase API 接口 100% 兼容
- Hook 机制完全兼容 (便于代码同步)
- Admin UI 功能不退化

### 3.2 可以放弃的特性
- UI 修改 Schema (生产环境最佳实践)
- UI 恢复数据库 (安全考虑)
- 单文件部署 (改为 Docker Compose)

### 3.3 性能指标
- 日志/监控系统对核心业务影响 < 3%
- 支持 5,000+ QPS 日志写入
- 支持 10k+ 实时连接

---

## 4. 数据库对比知识库

### 4.1 SQLite vs PostgreSQL vs DuckDB

| 维度 | SQLite | PostgreSQL | DuckDB |
|------|--------|------------|--------|
| **隐喻** | 生物器官 | 操作系统 | F1 引擎 |
| **美学** | 极简与可靠 | 严谨与扩展 | 速度的暴力美学 |
| **存储模型** | 行存 | 行存 | 列存 |
| **擅长场景** | 点查询 | 事务/关联 | 聚合分析 |
| **部署模式** | 嵌入式 | Client-Server | 嵌入式 |
| **并发模型** | 文件锁 | MVCC | 无锁读 |

### 4.2 架构决策矩阵

| 场景 | 推荐选型 | 理由 |
|------|---------|------|
| Edge/Local-first | SQLite | 网络不可靠时数据必须在本地 |
| 单机微型 SaaS | SQLite | 部署极简，成本极低 |
| AI Agent Memory | PostgreSQL | pgvector 向量搜索 |
| 复杂企业业务 | PostgreSQL | RLS、复杂事务 |
| 数据分析/数仓 | DuckDB | 列存 + 向量化执行 |

---

## 5. 风险评估

### 5.1 高风险项
1. **Schema 迁移逻辑**: SQLite 的松散类型 vs PostgreSQL 的严格类型
2. **JSON 查询转换**: `json_extract` → JSONB 操作符
3. **并发竞争**: 隐藏的 SQLite 文件锁依赖

### 5.2 中风险项
1. **全文搜索**: `LIKE %...%` 性能问题
2. **备份恢复**: `pg_dump` 集成复杂度
3. **连接池管理**: 泄漏检测、超时处理

### 5.3 低风险项
1. **日志系统**: 方案成熟，风险可控
2. **监控系统**: 降级策略完善
3. **实时同步**: `LISTEN/NOTIFY` 原生支持

---

## 6. 里程碑规划

| 版本 | 代号 | 核心目标 |
|------|------|---------|
| v2.0 | 基础层 | dbx 适配 + 单元测试 + LISTEN/NOTIFY 缓存失效 |
| v2.1 | 安全层 | set_config 会话变量 + RLS 编译器 |
| v2.2 | 实时层 | pglogrepl WAL 订阅 + 权限过滤 |
| v3.0 | 计算层 | wazero + QuickJS 替代 Goja |
