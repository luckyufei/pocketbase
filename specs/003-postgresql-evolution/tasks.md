# PocketBase PostgreSQL 演进 - Tasks 清单

> **兼容性要求**: PostgreSQL 15+

---

## EPIC-0: PostgreSQL 15 兼容性修复 (紧急)

> ⚠️ **重要**: 当前实现使用了 `JSON_QUERY` 函数，该函数是 **PostgreSQL 17** 才引入的 SQL/JSON 标准函数。
> 要兼容 PostgreSQL 15，必须用 `jsonb_path_query` 或传统 JSONB 操作符替代。

### STORY-0.1: JSON_QUERY 替换为 PG15 兼容方案

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-0.1.1 | 调研 `jsonb_path_query` 替代 `JSON_QUERY` 的可行性 | 2h | ✅ |
| T-0.1.2 | 重写 `json_query_or_null` 函数使用 `jsonb_path_query_first` | 4h | ✅ |
| T-0.1.3 | 更新 `tools/dbutils/json.go` 中的 `JSONExtract` 实现 | 4h | ✅ |
| T-0.1.4 | 更新 `tools/search/filter.go` 中的 JSON 路径查询 | 4h | ✅ |
| T-0.1.5 | 更新 `migrations/postgres_functions.go` 兼容函数 | 2h | ✅ |
| T-0.1.6 | 更新测试数据 `tests/data/*.pg-dump.sql` | 2h | ✅ |
| T-0.1.7 | 在 PostgreSQL 15 环境下运行全量测试 | 4h | ✅ |

**测试环境说明**:
- `tools/search` 和 `tools/dbutils` 测试已通过 ✅（使用 `dockertest`）
- `tests/` 包 PostgreSQL 集成测试已通过 ✅（使用 Docker 容器）
- `core` 包测试需要外部 PostgreSQL 工具（`createdb`, `psql`），待改造

**技术方案对比**:

| 方案 | PostgreSQL 版本 | 语法示例 |
|------|----------------|---------|
| `JSON_QUERY` (当前) | 17+ | `JSON_QUERY(col, '$.a.b')` |
| `jsonb_path_query` | 12+ | `jsonb_path_query(col::jsonb, '$.a.b')` |
| 传统操作符 | 9.4+ | `col->'a'->'b'` 或 `col#>'{a,b}'` |

**推荐方案**: 使用 `jsonb_path_query` (PostgreSQL 12+)，语法与 `JSON_QUERY` 相近，迁移成本最低。

---

## EPIC-1: 数据层解耦

### STORY-1.1: 类型系统适配

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.1.1 | 在 `tools/dbutils` 中实现布尔值转换器 | 2h | ✅ |
| T-1.1.2 | 实现 DateTime ↔ TIMESTAMPTZ 转换，保留微秒精度 | 4h | ✅ |
| T-1.1.3 | 验证 UUID v7 生成函数 `uuid_generate_v7` | 2h | ✅ |
| T-1.1.4 | 测试外键约束级联行为 | 2h | ✅ |
| T-1.1.5 | 编写类型转换单元测试 | 4h | ✅ |

### STORY-1.2: JSON 处理重写

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.2.1 | 分析现有 `json_extract` 调用点 | 2h | ✅ |
| T-1.2.2 | 实现 JSON 路径到 JSONB 操作符的 AST 转换 | 8h | ✅ |
| T-1.2.3 | ~~实现 `JSON_QUERY_OR_NULL` 兼容函数~~ → 已使用 `jsonb_path_query_first` 替代 | 2h | ✅ |
| T-1.2.4 | 修改 `tools/search/filter.go` 支持 JSONB 查询 | 8h | ✅ |
| T-1.2.5 | 实现 GIN 索引自动创建逻辑 | 4h | ✅ |
| T-1.2.6 | 编写 JSON 查询转换测试集 | 4h | ✅ |

### STORY-1.3: 并发模型验证

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.3.1 | 编写并发更新压力测试脚本 | 4h | ✅ |
| T-1.3.2 | 识别需要 `SELECT FOR UPDATE` 的关键操作 | 2h | ✅ |
| T-1.3.3 | 在 DAO 层引入悲观锁机制 | 4h | ✅ |
| T-1.3.4 | 实现可配置事务隔离级别 | 2h | ✅ |
| T-1.3.5 | 实现死锁检测和自动重试 | 4h | ✅ |

### STORY-1.4: 测试框架改造

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.4.1 | 集成 `dockertest` 库 | 2h | ✅ |
| T-1.4.2 | 编写 PostgreSQL 容器启动逻辑 | 2h | ✅ |
| T-1.4.3 | 实现测试 Schema 自动注入 | 2h | ✅ |
| T-1.4.4 | 新增 PostgreSQL 错误码测试用例 | 4h | ✅ |
| T-1.4.5 | 配置 CI/CD 双数据库测试 | 2h | ✅ |
| T-1.4.6 | **新增**: 配置 PostgreSQL 15 测试环境 | 2h | ✅ |

### STORY-1.5: 连接池管理

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.5.1 | 替换现有连接为 `pgxpool` | 2h | ✅ |
| T-1.5.2 | 添加连接池配置项 | 2h | ✅ |
| T-1.5.3 | 实现连接泄漏检测 | 4h | ✅ |
| T-1.5.4 | 暴露连接池状态指标 | 2h | ✅ |

---

## EPIC-2: 分布式事件网格

### STORY-2.1: LISTEN/NOTIFY 基础设施

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-2.1.1 | 创建事件监听 Goroutine | 2h | ✅ |
| T-2.1.2 | 定义事件 Payload 结构 | 1h | ✅ |
| T-2.1.3 | 实现 node_id 生成和比对 | 1h | ✅ |
| T-2.1.4 | 实现连接断开自动重连 | 2h | ✅ |
| T-2.1.5 | 编写 LISTEN/NOTIFY 单元测试 | 2h | ✅ |

### STORY-2.2: 缓存失效机制

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-2.2.1 | 在 `Save()` 后发送 NOTIFY | 2h | ✅ |
| T-2.2.2 | 在 `Delete()` 后发送 NOTIFY | 1h | ✅ |
| T-2.2.3 | 实现缓存失效处理器 | 2h | ✅ |
| T-2.2.4 | 支持按 Collection 粒度失效 | 2h | ✅ |
| T-2.2.5 | 性能测试：通知延迟 | 2h | ✅ |

### STORY-2.3: 分布式 Hook 执行

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-2.3.1 | 设计 Hook 执行模式配置 | 2h | ✅ |
| T-2.3.2 | 实现竞争消费模式（作业队列） | 4h | ✅ |
| T-2.3.3 | 实现广播模式 | 2h | ✅ |
| T-2.3.4 | 实现失败重试机制 | 4h | ✅ |

### STORY-2.4: 分布式 Cron 调度

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-2.4.1 | 实现 `pg_try_advisory_lock` 封装 | 2h | ✅ |
| T-2.4.2 | 改造 Cron 调度器使用分布式锁 | 4h | ✅ |
| T-2.4.3 | 实现任务执行状态查询 | 2h | ✅ |
| T-2.4.4 | 实现手动触发和强制释放锁 | 2h | ✅ |

---

## EPIC-3: 可观测性系统

### STORY-3.1: 高性能日志写入

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-3.1.1 | 创建 `request_logs` UNLOGGED 分区表 | 2h | ✅ |
| T-3.1.2 | 实现 Go Channel 日志缓冲 | 2h | ✅ |
| T-3.1.3 | 实现批量 `COPY` 写入 | 4h | ✅ |
| T-3.1.4 | 实现熔断机制（非阻塞丢弃） | 2h | ✅ |
| T-3.1.5 | 实现自动分区创建 Cron | 2h | ✅ |
| T-3.1.6 | 实现分区清理 Cron | 2h | ✅ |
| T-3.1.7 | 性能测试：5000 QPS 写入 | 2h | ✅ |

### STORY-3.2: 监控数据采集

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-3.2.1 | 创建 `monitoring` Schema | 1h | ✅ |
| T-3.2.2 | 创建 `metrics` UNLOGGED 分区表 | 2h | ✅ |
| T-3.2.3 | 实现内存预聚合缓冲 | 4h | ✅ |
| T-3.2.4 | 实现 10 秒级批量落库 | 2h | ✅ |
| T-3.2.5 | 创建 BRIN 索引 | 1h | ✅ |
| T-3.2.6 | 采集：内存使用 | 1h | ✅ |
| T-3.2.7 | 采集：Goroutine 数量 | 1h | ✅ |
| T-3.2.8 | 采集：DB 连接池状态 | 2h | ✅ |

### STORY-3.3: 监控专用连接

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-3.3.1 | 启动时保留专用连接 | 2h | ✅ |
| T-3.3.2 | 实现带超时的写入 | 2h | ✅ |
| T-3.3.3 | 超时时输出到 StdOut | 1h | ✅ |
| T-3.3.4 | 监控系统自身健康上报 | 2h | ✅ |

### STORY-3.4: 数据老化与降采样

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-3.4.1 | 实现自动分区清理 Cron | 2h | ✅ |
| T-3.4.2 | 创建每日聚合物化视图 | 2h | ✅ |
| T-3.4.3 | 实现物化视图刷新 Cron | 2h | ✅ |
| T-3.4.4 | 添加保留策略配置项 | 2h | ✅ |

---

## EPIC-4: 行级安全性

### STORY-4.1: 会话上下文注入

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-4.1.1 | 在 dbx 获取连接后注入 `set_config` | 4h | ✅ |
| T-4.1.2 | 注入 `pb.auth.id` | 1h | ✅ |
| T-4.1.3 | 注入 `pb.auth.role` | 1h | ✅ |
| T-4.1.4 | 验证事务结束后自动清除 | 2h | ✅ |
| T-4.1.5 | 连接复用安全测试 | 2h | ✅ |

### STORY-4.2: 规则编译器基础

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-4.2.1 | 解析 PocketBase 规则 AST | 8h | ✅ |
| T-4.2.2 | 实现 `@request.auth.id` 转换 | 2h | ✅ |
| T-4.2.3 | 实现字面量规则转换 | 2h | ✅ |
| T-4.2.4 | 生成 `CREATE POLICY` 语句 | 4h | ✅ |
| T-4.2.5 | 编写规则编译器测试 | 4h | ✅ |

### STORY-4.3: 跨集合规则转换

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-4.3.1 | 解析 `@collection` 语法 | 4h | ✅ |
| T-4.3.2 | 生成 `EXISTS` 子查询 | 8h | ✅ |
| T-4.3.3 | 处理关系字段查询 | 4h | ✅ |
| T-4.3.4 | 性能对比测试 | 4h | ✅ |
| T-4.3.5 | 边界情况处理 | 4h | ✅ |

---

## EPIC-5: 原生 Realtime 引擎

### STORY-5.1: WAL 消费者实现

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-5.1.1 | 集成 `jackc/pglogrepl` 库 | 2h | ✅ |
| T-5.1.2 | 创建 Replication Slot | 2h | ✅ |
| T-5.1.3 | 建立流式连接 | 4h | ✅ |
| T-5.1.4 | 解析 WAL 消息 | 8h | ✅ |
| T-5.1.5 | 转换为 PocketBase Record | 4h | ✅ |
| T-5.1.6 | 注入 Realtime 订阅管理器 | 4h | ✅ |

### STORY-5.2: 事件权限过滤

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-5.2.1 | 遍历在线订阅者 | 2h | ✅ |
| T-5.2.2 | 评估 ViewRule | 4h | ✅ |
| T-5.2.3 | 实现静态规则广播 | 2h | ✅ |
| T-5.2.4 | 实现动态规则精确推送 | 4h | ✅ |
| T-5.2.5 | 实现布隆过滤器优化 | 8h | ✅ |
| T-5.2.6 | 实现角色分组优化 | 4h | ✅ |

---

## EPIC-7: PostgreSQL 扩展生态

### STORY-7.1: 向量字段类型

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-7.1.1 | 定义 `vector` 字段类型 | 2h | ✅ |
| T-7.1.2 | Admin UI 添加 vector 字段支持 | 4h | ✅ |
| T-7.1.3 | 自动执行 `CREATE EXTENSION vector` | 2h | ✅ |
| T-7.1.4 | 自动创建 HNSW 索引 | 2h | ✅ |
| T-7.1.5 | API 支持 `<->` 距离查询 | 4h | ✅ |
| T-7.1.6 | API 支持 `<#>` 余弦距离查询 | 2h | ✅ |

### STORY-7.2: 全文搜索优化

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-7.2.1 | 自动执行 `CREATE EXTENSION pg_trgm` | 1h | ✅ |
| T-7.2.2 | 创建 GIN 索引加速 LIKE 查询 | 2h | ✅ |
| T-7.2.3 | 可选：实现 tsvector 全文搜索 | 8h | ✅ |
| T-7.2.4 | 性能对比测试 | 2h | ✅ |

---

## EPIC-8: 运维与部署

### STORY-8.1: 启动引导改造

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-8.1.1 | 检查 PostgreSQL 连接 | 1h | ✅ |
| T-8.1.2 | 检查 `admin` 表是否存在 | 1h | ✅ |
| T-8.1.3 | 执行初始化 SQL | 2h | ✅ |
| T-8.1.4 | 引导创建管理员账号 | 2h | ✅ |
| T-8.1.5 | 重写 `core/app.go` 启动逻辑 | 4h | ✅ |

### STORY-8.2: 备份导出集成

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-8.2.1 | 拦截 Admin UI 备份请求 | 2h | ✅ |
| T-8.2.2 | 调用 `pg_dump` 生成转储 | 2h | ✅ |
| T-8.2.3 | 流式写入 ZIP | 2h | ✅ |
| T-8.2.4 | 包含上传文件打包 | 2h | ✅ |
| T-8.2.5 | 实现定时自动备份 | 2h | ✅ |

### STORY-8.3: 容器化部署模板

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-8.3.1 | 编写 Dockerfile | 1h | ✅ |
| T-8.3.2 | 编写 docker-compose.yml | 2h | ✅ |
| T-8.3.3 | 配置环境变量 | 1h | ✅ |
| T-8.3.4 | 配置健康检查 | 1h | ✅ |
| T-8.3.5 | 配置持久化卷 | 1h | ✅ |

---

## 工作量汇总

| EPIC | Tasks 数量 | 预估工时 |
|------|-----------|---------|
| **EPIC-0: PG15 兼容性** | **7** | **22h** |
| EPIC-1: 数据层解耦 | 26 | 76h |
| EPIC-2: 分布式事件网格 | 18 | 40h |
| EPIC-3: 可观测性系统 | 24 | 48h |
| EPIC-4: 行级安全性 | 15 | 54h |
| EPIC-5: 原生 Realtime | 12 | 48h |
| EPIC-7: 扩展生态 | 10 | 29h |
| EPIC-8: 运维部署 | 15 | 24h |
| **总计** | **127** | **341h** |

---

## 执行顺序建议

### Phase 0: 紧急修复 (P0-Critical) - 约 22h
0. **STORY-0.1**: PostgreSQL 15 兼容性修复 (JSON_QUERY → jsonb_path_query)

### Phase 1: MVP (P0) - 约 114h
1. STORY-1.1 → STORY-1.2 → STORY-1.3 → STORY-1.4 → STORY-1.5
2. STORY-2.1 → STORY-2.2 → STORY-2.3 → STORY-2.4

### Phase 2: 生产就绪 (P1) - 约 126h
3. STORY-3.1 → STORY-3.2 → STORY-3.3 → STORY-3.4
4. STORY-4.1 → STORY-4.2 → STORY-4.3
5. STORY-8.1 → STORY-8.2 → STORY-8.3

### Phase 3: 增强 (P2) - 约 77h
6. STORY-5.1 → STORY-5.2
7. STORY-7.1 → STORY-7.2

### Phase 4: 未来 (P3) - 待定
8. EPIC-6: WASM 计算运行时 (独立规划)
