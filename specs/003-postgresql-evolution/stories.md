# PocketBase PostgreSQL 演进 - User Stories

---

## EPIC-1: 数据层解耦

### STORY-1.1: 类型系统适配
**作为** 开发者
**我想要** PocketBase 能自动处理 SQLite 和 PostgreSQL 的类型差异
**以便于** 无需修改业务代码即可切换数据库

**验收标准**:
- [ ] 布尔值：Go `bool` ↔ PostgreSQL `BOOLEAN` 自动转换
- [ ] 时间戳：字符串 ↔ `TIMESTAMPTZ` 自动转换，保留微秒精度
- [ ] ID：支持原有字符串 ID，可选迁移至 UUID v7
- [ ] 大整数：正确处理 64 位整数边界

**Story Points**: 8

---

### STORY-1.2: JSON 处理重写
**作为** 开发者
**我想要** JSON 字段查询在 PostgreSQL 上正常工作
**以便于** 动态字段过滤功能不退化

**验收标准**:
- [ ] `json_extract` → JSONB 操作符 (`->`, `->>`, `@>`) 转换
- [ ] 嵌套路径查询：`data.settings.enabled = true` 正确转换
- [ ] GIN 索引：常用 JSON 路径自动创建索引
- [ ] AST 转换测试集覆盖

**Story Points**: 13

---

### STORY-1.3: 并发模型验证
**作为** 开发者
**我想要** 确保高并发场景下数据一致性
**以便于** 从 SQLite 迁移后不出现竞态条件

**验收标准**:
- [ ] 编写并发压力测试（多 Goroutine 同时更新同一记录）
- [ ] 关键操作引入 `SELECT FOR UPDATE` 悲观锁
- [ ] 可配置事务隔离级别 (`SERIALIZABLE`)
- [ ] 死锁检测和自动重试机制

**Story Points**: 8

---

### STORY-1.4: 测试框架改造
**作为** 开发者
**我想要** 单元测试能在 PostgreSQL 环境下运行
**以便于** 验证适配的完整性

**验收标准**:
- [ ] 集成 `dockertest` 动态拉取 PostgreSQL 容器
- [ ] 测试前自动注入 Schema
- [ ] 新增 PostgreSQL 特有错误码测试用例
- [ ] CI/CD 支持双数据库测试

**Story Points**: 5

---

### STORY-1.5: 连接池管理
**作为** 运维人员
**我想要** 数据库连接池可配置和监控
**以便于** 避免连接泄漏和资源耗尽

**验收标准**:
- [ ] 使用 `pgxpool` 管理连接
- [ ] 可配置：最大连接数、空闲超时、连接生命周期
- [ ] 连接泄漏检测告警
- [ ] 连接池状态暴露给监控系统

**Story Points**: 5

---

## EPIC-2: 分布式事件网格

### STORY-2.1: LISTEN/NOTIFY 基础设施
**作为** 开发者
**我想要** 多实例间能通过数据库通信
**以便于** 实现分布式事件传播

**验收标准**:
- [ ] 启动时创建专用 Goroutine 执行 `LISTEN pb_events`
- [ ] 事件 Payload 包含：type, collection, id, node_id
- [ ] 防止回声循环（忽略自己发出的事件）
- [ ] 连接断开自动重连

**Story Points**: 5

---

### STORY-2.2: 缓存失效机制
**作为** 开发者
**我想要** 数据变更时所有实例缓存自动失效
**以便于** 多实例部署时数据一致

**验收标准**:
- [ ] `Save()` / `Delete()` 后发送 NOTIFY
- [ ] 其他实例收到通知后清除对应缓存
- [ ] 支持按 Collection 粒度失效
- [ ] 性能：通知延迟 < 100ms

**Story Points**: 5

---

### STORY-2.3: 分布式 Hook 执行
**作为** 开发者
**我想要** 事务后 Hook 在多实例环境正确执行
**以便于** 避免重复执行（如发送多封邮件）

**验收标准**:
- [ ] 竞争消费模式：基于数据库作业队列或分布式锁
- [ ] 广播模式：所有实例都执行（缓存失效、实时订阅更新）
- [ ] Hook 类型可配置执行模式
- [ ] 失败重试机制

**Story Points**: 8

---

### STORY-2.4: 分布式 Cron 调度
**作为** 开发者
**我想要** 定时任务在多实例环境只执行一次
**以便于** 避免任务重复执行

**验收标准**:
- [ ] 使用 `pg_try_advisory_lock` 实现分布式锁
- [ ] 锁为会话级别，崩溃自动释放
- [ ] 任务执行状态可查询
- [ ] 支持手动触发和强制释放锁

**Story Points**: 5

---

## EPIC-3: 可观测性系统

### STORY-3.1: 高性能日志写入
**作为** 运维人员
**我想要** API 请求日志不影响核心业务性能
**以便于** 在高负载下依然可观测

**验收标准**:
- [ ] 使用 `UNLOGGED TABLE` 避免 WAL 开销
- [ ] 按天分区，`DROP PARTITION` 清理旧数据
- [ ] Go 层 Channel 缓冲 + 批量 `COPY` 写入
- [ ] 熔断机制：缓冲满时丢弃日志

**Story Points**: 8

---

### STORY-3.2: 监控数据采集
**作为** 运维人员
**我想要** 实时监控服务健康状态
**以便于** 及时发现和处理问题

**验收标准**:
- [ ] 采集指标：内存、Goroutine、DB 连接池、QPS
- [ ] 独立 Schema (`monitoring`) 逻辑隔离
- [ ] BRIN 索引优化时序查询
- [ ] 内存预聚合，10 秒级落库

**Story Points**: 8

---

### STORY-3.3: 监控专用连接
**作为** 运维人员
**我想要** 监控系统在数据库压力大时依然可用
**以便于** 在故障时能观测到问题

**验收标准**:
- [ ] 保留专用连接，不归还连接池
- [ ] 写入超时 500ms，超时丢弃
- [ ] 超时时输出到 StdOut 作为最后告警
- [ ] 监控系统自身健康状态上报

**Story Points**: 5

---

### STORY-3.4: 数据老化与降采样
**作为** 运维人员
**我想要** 历史监控数据自动清理和聚合
**以便于** 控制存储成本

**验收标准**:
- [ ] 自动分区清理：保留最近 7 天原始数据
- [ ] 物化视图：每天聚合统计数据
- [ ] 可配置保留策略
- [ ] 清理任务使用分布式锁

**Story Points**: 5

---

## EPIC-4: 行级安全性

### STORY-4.1: 会话上下文注入
**作为** 开发者
**我想要** 每个请求的用户上下文传递给数据库
**以便于** RLS 策略能识别当前用户

**验收标准**:
- [ ] 使用 `set_config('pb.auth.id', ...)` 注入用户 ID
- [ ] 使用 `set_config('pb.auth.role', ...)` 注入角色
- [ ] 参数 `true` 确保事务结束自动清除
- [ ] 连接复用时无信息泄露

**Story Points**: 5

---

### STORY-4.2: 规则编译器基础
**作为** 开发者
**我想要** PocketBase API Rules 自动转换为 RLS Policies
**以便于** 安全策略下沉到数据库

**验收标准**:
- [ ] 解析 PocketBase 规则 AST
- [ ] `id = @request.auth.id` → `id = current_setting('pb.auth.id', true)`
- [ ] `status = 'public'` → `status = 'public'`
- [ ] 生成 `CREATE POLICY` 语句

**Story Points**: 13

---

### STORY-4.3: 跨集合规则转换
**作为** 开发者
**我想要** 复杂的跨表权限规则也能转换
**以便于** 支持完整的 PocketBase 权限模型

**验收标准**:
- [ ] `@collection.posts...` 转换为 `EXISTS` 子查询
- [ ] 关系字段查询正确转换
- [ ] 性能测试：RLS vs 应用层过滤
- [ ] 边界情况处理和错误提示

**Story Points**: 13

---

## EPIC-5: 原生 Realtime 引擎

### STORY-5.1: WAL 消费者实现
**作为** 开发者
**我想要** 捕获所有数据库变更事件
**以便于** 实现真正的 Realtime 推送

**验收标准**:
- [ ] 使用 `jackc/pglogrepl` 建立逻辑复制连接
- [ ] 创建 Replication Slot，使用 `pgoutput` 插件
- [ ] 解析 WAL 消息为 Insert/Update/Delete 事件
- [ ] 转换为 PocketBase Record 对象

**Story Points**: 13

---

### STORY-5.2: 事件权限过滤
**作为** 开发者
**我想要** WAL 事件按用户权限过滤后推送
**以便于** 不泄露无权限数据

**验收标准**:
- [ ] 遍历在线订阅者，评估 ViewRule
- [ ] 静态规则（如 `status = 'public'`）广播给所有人
- [ ] 动态规则（如 `id = @request.auth.id`）精确推送
- [ ] 布隆过滤器或角色分组优化性能

**Story Points**: 13

---

## EPIC-7: PostgreSQL 扩展生态

### STORY-7.1: 向量字段类型
**作为** AI 开发者
**我想要** 在 PocketBase 中存储和查询向量
**以便于** 实现语义搜索功能

**验收标准**:
- [ ] 新增 `vector` 字段类型
- [ ] Admin UI 添加字段时自动 `CREATE EXTENSION vector`
- [ ] 自动创建 HNSW 索引
- [ ] API 支持 `<->` (欧几里得) 和 `<#>` (余弦) 距离查询

**Story Points**: 8

---

### STORY-7.2: 全文搜索优化
**作为** 开发者
**我想要** 模糊搜索在大表上依然高效
**以便于** 用户搜索体验不退化

**验收标准**:
- [ ] 引入 `pg_trgm` 扩展
- [ ] `LIKE %...%` 查询利用 GIN 索引
- [ ] 可选：`tsvector` / `tsquery` 全文搜索
- [ ] 性能对比测试

**Story Points**: 5

---

## EPIC-8: 运维与部署

### STORY-8.1: 启动引导改造
**作为** 开发者
**我想要** 空数据库能自动初始化
**以便于** 首次部署无需手动建表

**验收标准**:
- [ ] 检查 PostgreSQL 连接是否通畅
- [ ] 检查 `admin` 表是否存在
- [ ] 不存在时执行初始化 SQL (Bootstrapping)
- [ ] 引导创建第一个管理员账号

**Story Points**: 5

---

### STORY-8.2: 备份导出集成
**作为** 运维人员
**我想要** 在 Admin UI 导出数据库备份
**以便于** 数据安全有保障

**验收标准**:
- [ ] 拦截备份请求，调用 `pg_dump`
- [ ] SQL 转储文件流式写入 ZIP
- [ ] 包含上传文件一起打包
- [ ] 支持定时自动备份

**Story Points**: 5

---

### STORY-8.3: 容器化部署模板
**作为** 运维人员
**我想要** 开箱即用的部署配置
**以便于** 快速上线生产环境

**验收标准**:
- [ ] Docker Compose 模板：App + PostgreSQL
- [ ] 环境变量配置：连接串、端口、密码
- [ ] 健康检查配置
- [ ] 持久化卷配置

**Story Points**: 3

---

## Story Points 汇总

| EPIC | Stories | Total Points |
|------|---------|--------------|
| EPIC-1: 数据层解耦 | 5 | 39 |
| EPIC-2: 分布式事件网格 | 4 | 23 |
| EPIC-3: 可观测性系统 | 4 | 26 |
| EPIC-4: 行级安全性 | 3 | 31 |
| EPIC-5: 原生 Realtime | 2 | 26 |
| EPIC-7: 扩展生态 | 2 | 13 |
| EPIC-8: 运维部署 | 3 | 13 |
| **总计** | **23** | **171** |
