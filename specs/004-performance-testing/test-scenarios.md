# 性能测试场景设计

> **设计原则**: 基于真实业务场景，覆盖典型使用模式，从轻负载到极限负载渐进式测试

## 场景分类

### 1. 微型应用场景 (Micro App)
**特征**: 个人项目、原型应用、小团队工具
- 用户数: < 100
- 数据量: < 10MB
- 并发: < 10
- 典型用例: 个人博客、待办事项、小型 CMS

### 2. 小型应用场景 (Small App)  
**特征**: 初创公司产品、部门级应用
- 用户数: 100 - 1,000
- 数据量: 10MB - 100MB
- 并发: 10 - 50
- 典型用例: 团队协作工具、小型电商、社区论坛

### 3. 中型应用场景 (Medium App)
**特征**: 成长期产品、企业级应用
- 用户数: 1,000 - 10,000  
- 数据量: 100MB - 1GB
- 并发: 50 - 200
- 典型用例: SaaS 产品、企业内部系统、中型电商

### 4. 大型应用场景 (Large App)
**特征**: 成熟产品、高流量应用
- 用户数: 10,000 - 100,000
- 数据量: 1GB - 10GB
- 并发: 200 - 1,000
- 典型用例: 大型 SaaS、社交平台、内容管理系统

### 5. 极限场景 (Extreme Load)
**特征**: 压力测试、性能边界探索
- 用户数: > 100,000
- 数据量: > 10GB
- 并发: > 1,000
- 典型用例: 性能基准测试、容量规划

## 核心测试场景

### S1: 用户认证与会话管理

#### S1.1 用户注册流程
```yaml
场景描述: 新用户批量注册
测试参数:
  - 并发用户: 10, 50, 100, 500
  - 注册速率: 1/s, 10/s, 50/s, 100/s
  - 数据复杂度: 基础字段, 扩展字段, 文件上传
性能指标:
  - 注册成功率: > 99.9%
  - 响应时间: P95 < 200ms
  - 数据库写入: < 100ms
验证点:
  - 邮箱验证发送延迟
  - 密码加密性能
  - 用户数据持久化
```

#### S1.2 用户登录认证
```yaml
场景描述: 高频用户登录
测试参数:
  - 并发登录: 50, 200, 500, 1000
  - 登录频率: 持续, 突发, 周期性
  - 认证方式: 密码, OAuth2, JWT 刷新
性能指标:
  - 登录成功率: > 99.95%
  - 认证延迟: P95 < 100ms
  - Token 生成: < 50ms
验证点:
  - 密码验证性能
  - JWT 签名/验证
  - 会话存储效率
```

#### S1.3 会话保持与刷新
```yaml
场景描述: 长连接会话管理
测试参数:
  - 活跃会话: 100, 500, 1000, 5000
  - 会话时长: 1h, 8h, 24h
  - 刷新频率: 5min, 15min, 1h
性能指标:
  - 会话维持成功率: > 99.9%
  - Token 刷新延迟: P95 < 50ms
  - 内存使用: 线性增长
验证点:
  - 会话存储策略
  - 过期清理机制
  - 内存泄漏检测
```

### S2: 数据 CRUD 操作

#### S2.1 高频读取场景
```yaml
场景描述: 热点数据频繁查询
测试参数:
  - 查询 QPS: 100, 500, 1000, 2000
  - 数据集大小: 1K, 10K, 100K, 1M 记录
  - 查询复杂度: 简单查询, 关联查询, 聚合查询
  - 缓存策略: 无缓存, 应用缓存, 数据库缓存
性能指标:
  - 查询 QPS: SQLite > 1000, PostgreSQL > 2000
  - 查询延迟: P95 < 50ms, P99 < 100ms
  - CPU 使用率: < 70%
验证点:
  - 索引效果验证
  - 查询计划优化
  - 连接池效率
```

#### S2.2 批量写入场景
```yaml
场景描述: 大批量数据导入
测试参数:
  - 批量大小: 100, 1000, 10000 记录/批次
  - 写入频率: 1批次/s, 10批次/s, 100批次/s
  - 数据复杂度: 简单记录, 复杂 JSON, 关联数据
  - 事务策略: 单条事务, 批量事务, 批处理
性能指标:
  - 写入 TPS: SQLite > 500, PostgreSQL > 1000
  - 写入延迟: P95 < 100ms
  - 事务成功率: > 99.9%
验证点:
  - 事务隔离级别
  - 锁竞争情况
  - WAL 性能影响
```

#### S2.3 混合读写场景
```yaml
场景描述: 真实业务读写混合
测试参数:
  - 读写比例: 9:1, 7:3, 5:5, 3:7
  - 总 QPS: 500, 1000, 2000, 5000
  - 数据热度: 热点数据, 均匀分布, 冷热混合
  - 并发模式: 读写分离, 混合并发
性能指标:
  - 整体 QPS: 目标值的 90%+
  - 读延迟: P95 < 50ms
  - 写延迟: P95 < 100ms
验证点:
  - 读写锁冲突
  - 连接池分配
  - 缓存一致性
```

### S3: 实时功能测试

#### S3.1 WebSocket 连接管理
```yaml
场景描述: 大量 WebSocket 长连接
测试参数:
  - 连接数: 100, 500, 1000, 5000
  - 连接建立速率: 10/s, 50/s, 100/s
  - 连接保持时长: 10min, 1h, 8h
  - 心跳频率: 30s, 60s, 300s
性能指标:
  - 连接成功率: > 99.9%
  - 连接建立延迟: P95 < 100ms
  - 内存使用: < 1MB/1000连接
验证点:
  - 连接池管理
  - 内存使用优化
  - 连接清理机制
```

#### S3.2 实时消息推送
```yaml
场景描述: 高频实时消息分发
测试参数:
  - 消息频率: 10/s, 100/s, 1000/s
  - 订阅者数量: 100, 500, 1000, 5000
  - 消息大小: 1KB, 10KB, 100KB
  - 推送模式: 广播, 定向, 分组
性能指标:
  - 消息延迟: P95 < 100ms
  - 消息丢失率: < 0.1%
  - 吞吐量: > 10000 msg/s
验证点:
  - 消息队列性能
  - 订阅管理效率
  - 网络带宽使用
```

#### S3.3 数据变更通知
```yaml
场景描述: 数据库变更实时通知
测试参数:
  - 变更频率: 10/s, 100/s, 500/s
  - 订阅规则: 全表, 条件过滤, 字段级别
  - 通知延迟: 实时, 批量, 定时
  - 订阅者数: 10, 100, 500
性能指标:
  - 通知延迟: P95 < 200ms
  - 过滤准确率: > 99.9%
  - CPU 开销: < 20%
验证点:
  - 变更检测机制
  - 过滤规则性能
  - 通知分发效率
```

### S4: 文件存储测试

#### S4.1 文件上传性能
```yaml
场景描述: 多文件并发上传
测试参数:
  - 并发上传: 10, 50, 100 个文件
  - 文件大小: 1MB, 10MB, 100MB, 1GB
  - 文件类型: 图片, 文档, 视频, 压缩包
  - 存储后端: 本地, S3, MinIO
性能指标:
  - 上传速度: > 10MB/s
  - 并发处理: 100 个文件同时
  - 成功率: > 99.9%
验证点:
  - 内存使用控制
  - 磁盘 I/O 性能
  - 网络带宽利用
```

#### S4.2 文件下载性能
```yaml
场景描述: 高并发文件下载
测试参数:
  - 并发下载: 50, 200, 500
  - 文件大小: 1MB, 10MB, 100MB
  - 缓存策略: 无缓存, CDN, 本地缓存
  - 访问模式: 热点文件, 随机访问
性能指标:
  - 下载速度: > 50MB/s
  - 并发支持: 500 个连接
  - 缓存命中率: > 80%
验证点:
  - 静态文件服务
  - 缓存效果验证
  - 带宽控制机制
```

#### S4.3 缩略图生成
```yaml
场景描述: 图片缩略图批量生成
测试参数:
  - 图片数量: 100, 1000, 10000
  - 图片大小: 1MB, 5MB, 20MB
  - 缩略图规格: 多种尺寸组合
  - 处理模式: 同步, 异步, 队列
性能指标:
  - 处理速度: > 10 张/秒
  - CPU 使用: < 80%
  - 内存控制: < 500MB
验证点:
  - 图片处理性能
  - 内存使用优化
  - 异步处理效果
```

### S5: 复杂查询测试

#### S5.1 关联查询性能
```yaml
场景描述: 多表关联复杂查询
测试参数:
  - 关联表数: 2, 3, 5, 10
  - 数据量: 1K, 10K, 100K 每表
  - 查询复杂度: 简单 JOIN, 嵌套查询, 子查询
  - 索引策略: 无索引, 单列索引, 复合索引
性能指标:
  - 查询延迟: P95 < 200ms
  - 查询 QPS: > 100
  - 资源使用: CPU < 70%
验证点:
  - 查询计划优化
  - 索引使用效果
  - 内存使用控制
```

#### S5.2 全文搜索性能
```yaml
场景描述: 大文本全文搜索
测试参数:
  - 文档数量: 1K, 10K, 100K, 1M
  - 文档大小: 1KB, 10KB, 100KB
  - 搜索复杂度: 单词, 短语, 模糊匹配
  - 搜索引擎: SQLite FTS, PostgreSQL tsvector
性能指标:
  - 搜索延迟: P95 < 500ms
  - 搜索 QPS: > 50
  - 索引大小: < 原数据 50%
验证点:
  - 全文索引效果
  - 搜索准确性
  - 索引更新性能
```

#### S5.3 聚合统计查询
```yaml
场景描述: 大数据量聚合分析
测试参数:
  - 数据量: 10K, 100K, 1M, 10M 记录
  - 聚合类型: COUNT, SUM, AVG, GROUP BY
  - 时间范围: 1天, 1周, 1月, 1年
  - 分组维度: 单维度, 多维度, 嵌套分组
性能指标:
  - 聚合延迟: P95 < 1s
  - 内存使用: < 1GB
  - 准确性: 100%
验证点:
  - 聚合算法优化
  - 内存使用控制
  - 并行处理能力
```

## 数据库特定场景

### SQLite 专项测试

#### SQLite-1: WAL 模式性能
```yaml
场景描述: WAL 模式下的并发读写
测试重点:
  - WAL 文件大小控制
  - Checkpoint 性能影响
  - 并发读取性能
  - 写入阻塞情况
```

#### SQLite-2: 内存数据库
```yaml
场景描述: 内存模式性能对比
测试重点:
  - 内存 vs 磁盘性能差异
  - 内存使用量控制
  - 数据持久化策略
  - 崩溃恢复能力
```

### PostgreSQL 专项测试

#### PostgreSQL-1: 连接池效果
```yaml
场景描述: pgxpool 连接池性能
测试重点:
  - 连接池大小优化
  - 连接获取延迟
  - 连接泄漏检测
  - 连接复用效率
```

#### PostgreSQL-2: 事务隔离级别
```yaml
场景描述: 不同隔离级别性能
测试重点:
  - Read Committed vs Serializable
  - 锁竞争情况
  - 死锁检测恢复
  - 并发事务性能
```

#### PostgreSQL-3: 分区表性能
```yaml
场景描述: 大表分区策略
测试重点:
  - 分区裁剪效果
  - 跨分区查询性能
  - 分区维护开销
  - 并行查询能力
```

## 多节点集群场景

### Cluster-1: 读写分离
```yaml
场景描述: 主从读写分离性能
测试参数:
  - 主从延迟: < 100ms
  - 读写比例: 9:1, 7:3, 5:5
  - 故障切换: 主库故障恢复
  - 负载均衡: 读请求分发
性能指标:
  - 读扩展效果: 线性增长
  - 写性能保持: 无明显下降
  - 数据一致性: 最终一致
```

### Cluster-2: 水平扩展
```yaml
场景描述: 多节点水平扩展
测试参数:
  - 节点数量: 2, 3, 5, 10
  - 负载分发: 轮询, 权重, 一致性哈希
  - 数据分片: 按用户, 按时间, 按功能
  - 跨节点查询: 分布式 JOIN
性能指标:
  - 扩展线性度: > 80%
  - 跨节点延迟: < 200ms
  - 数据一致性: 强一致性
```

### Cluster-3: 高可用性
```yaml
场景描述: 故障恢复和容灾
测试参数:
  - 故障类型: 节点宕机, 网络分区, 磁盘故障
  - 恢复时间: < 30s
  - 数据丢失: 0 丢失
  - 服务降级: 优雅降级
性能指标:
  - 可用性: > 99.9%
  - 恢复时间: < 1min
  - 数据完整性: 100%
```

## 测试数据设计

### 数据模型
```yaml
用户表 (users):
  - 记录数: 1K - 1M
  - 字段: id, email, name, avatar, profile(JSON), created, updated
  
文章表 (posts):
  - 记录数: 10K - 10M  
  - 字段: id, title, content, author_id, tags(JSON), status, created
  
评论表 (comments):
  - 记录数: 100K - 100M
  - 字段: id, post_id, user_id, content, parent_id, created
  
文件表 (files):
  - 记录数: 1K - 1M
  - 字段: id, name, size, type, path, owner_id, created
```

### 数据分布
```yaml
热点数据: 20% 数据占 80% 访问
冷数据: 80% 数据占 20% 访问
数据增长: 每日 1% - 10% 增长
数据删除: 每月 5% - 20% 清理
```

## 性能基准目标

### SQLite 基准
```yaml
轻负载 (< 10 并发):
  - 读 QPS: > 1000
  - 写 QPS: > 500
  - 响应时间: P95 < 50ms
  
中负载 (10-50 并发):
  - 读 QPS: > 800
  - 写 QPS: > 300
  - 响应时间: P95 < 100ms
  
高负载 (50+ 并发):
  - 读 QPS: > 500
  - 写 QPS: > 200
  - 响应时间: P95 < 200ms
```

### PostgreSQL 单节点基准
```yaml
轻负载 (< 50 并发):
  - 读 QPS: > 2000
  - 写 QPS: > 1000
  - 响应时间: P95 < 50ms
  
中负载 (50-200 并发):
  - 读 QPS: > 1500
  - 写 QPS: > 800
  - 响应时间: P95 < 100ms
  
高负载 (200+ 并发):
  - 读 QPS: > 1000
  - 写 QPS: > 500
  - 响应时间: P95 < 200ms
```

### PostgreSQL 集群基准
```yaml
2 节点集群:
  - 读扩展: 1.8x
  - 写性能: 0.9x (复制开销)
  
3 节点集群:
  - 读扩展: 2.5x
  - 写性能: 0.85x
  
5 节点集群:
  - 读扩展: 4x
  - 写性能: 0.8x
```

---

**下一步**: 实现具体的基准测试工具和自动化测试脚本