# PocketBase 性能测试 - Tasks 清单

> **测试环境**: MacBook Pro M1 Pro (32GB RAM, 10核心) + Docker/Colima
> **测试覆盖**: SQLite + PostgreSQL (单节点 + 集群)
> **目标**: 建立全面的性能基准，验证 PocketBase 核心价值主张

---

## 📁 项目结构

性能测试代码已迁移到项目根目录 `benchmarks/`，支持跨环境重复执行：

```
benchmarks/
├── cmd/                    # 命令行工具
│   ├── benchmark/          # 统一命令行入口
│   ├── pg-compare/         # PostgreSQL vs SQLite 对比
│   └── cluster-benchmark/  # 集群性能测试
├── configs/                # 环境配置文件
│   ├── local-sqlite.json   # 本地 SQLite 测试
│   ├── local-postgres.json # 本地 PostgreSQL 测试
│   ├── docker-postgres.json # Docker 环境测试
│   └── production.json     # 生产环境测试
├── docker/                 # Docker 环境配置
│   ├── docker-compose.yml  # 单节点环境
│   └── docker-compose-cluster.yml # 集群环境
├── scripts/                # 初始化脚本
│   ├── 01-init-extensions.sql
│   ├── primary-init.sh
│   ├── setup-replica.sh
│   ├── haproxy.cfg
│   └── prometheus-cluster.yml
├── monitoring/             # 监控配置
│   └── prometheus.yml
├── reports/                # 测试报告 (git 管理)
│   ├── comparison/         # PostgreSQL vs SQLite 对比
│   ├── cluster/            # 集群测试报告
│   ├── sqlite/             # SQLite 报告
│   └── REPORTS.md          # 报告汇总
├── http/                   # HTTP API 负载测试
├── websocket/              # WebSocket 实时连接测试
├── database/               # 数据库直连测试
├── report/                 # 报告生成工具
├── environment/            # 环境验证测试
├── config.go               # 配置管理
├── database.go             # 数据库抽象层
├── data_generator.go       # 测试数据生成
├── result.go               # 结果统计
├── runner.go               # 测试运行器
├── sqlite_benchmark.go     # SQLite 基准测试
├── postgres_benchmark.go   # PostgreSQL 基准测试
├── *_test.go               # 单元测试
├── Makefile                # 构建和运行脚本
└── go.mod
```

### 快速开始

```bash
cd benchmarks

# 构建
make build

# 查看帮助
./bin/benchmark -help

# 运行完整测试套件
make run-all

# 运行 SQLite 测试 (不同规模)
make run-sqlite-small
make run-sqlite-medium
make run-sqlite-large

# 运行 HTTP API 测试
make run-http

# 运行 WebSocket 测试
make run-websocket

# 运行数据库直连测试
make run-database

# 使用配置文件运行
./bin/benchmark -config configs/local-sqlite.json
./bin/benchmark -config configs/docker-postgres.json

# 命令行参数运行
./bin/benchmark -test sqlite -db sqlite -scale medium -duration 60s -verbose
./bin/benchmark -test http -url http://localhost:8090 -concurrency 50
```

### 测试类型

| 类型 | 命令 | 说明 |
|------|------|------|
| all | `make run-all` | 完整测试套件 (数据库 + HTTP + WebSocket) |
| sqlite | `make run-sqlite-small` | SQLite 基准测试 |
| database | `make run-database` | 数据库直连测试 (SQLite/PostgreSQL) |
| http | `make run-http` | HTTP API 负载测试 |
| websocket | `make run-websocket` | WebSocket 实时连接测试 |

### 环境配置

| 配置文件 | 环境 | 数据库 | 用途 |
|----------|------|--------|------|
| local-sqlite.json | local | SQLite | MacBook 本地开发测试 |
| local-postgres.json | local | PostgreSQL | 本地 PostgreSQL 测试 |
| docker-postgres.json | docker | PostgreSQL | Docker 容器环境测试 |
| production.json | production | PostgreSQL | 生产服务器测试 |

---

## EPIC-0: 基础设施准备

> 🎯 **目标**: 搭建完整的性能测试环境，开发测试工具套件
> ⏱️ **时间**: 1-2 周
> 💻 **环境**: MacBook 本地环境

### STORY-0.1: 测试环境搭建

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-0.1.1 | 优化 Colima 配置 (8 CPU, 24GB RAM, 100GB 磁盘) | 1h | ✅ |
| T-0.1.2 | 创建 Docker Compose 环境配置文件 | 2h | ✅ |
| T-0.1.3 | 搭建 PostgreSQL 15/16/17/18 多版本测试环境 | 4h | ✅ |
| T-0.1.4 | 配置 Prometheus + Grafana 监控系统 | 6h | ✅ |
| T-0.1.5 | 验证网络连通性和基础性能 | 2h | ✅ |

**技术要求**:
```yaml
Docker 配置:
  - CPU: 8 核心 (为 macOS 保留 2 核心)
  - 内存: 24GB (为 macOS 保留 8GB)
  - 存储: 100GB NVMe 空间
  - 网络: bridge 模式，支持容器间通信

PostgreSQL 版本:
  - postgres:15-alpine (基准版本)
  - postgres:16-alpine (主流版本)
  - postgres:17-alpine (最新稳定版)
  - postgres:18-alpine (最新版本)
```

### STORY-0.2: 测试工具开发

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-0.2.1 | 开发 HTTP API 压测工具 (支持 REST + 认证) | 8h | ✅ |
| T-0.2.2 | 开发 WebSocket 实时连接压测工具 | 6h | ✅ |
| T-0.2.3 | 开发数据库直连性能测试工具 | 6h | ✅ |
| T-0.2.4 | 集成 Prometheus 指标收集和导出 | 4h | ✅ |
| T-0.2.5 | 开发自动化报告生成工具 | 6h | ✅ |

**工具架构**:
```yaml
HTTP 压测工具:
  - 支持 CRUD 操作模拟
  - 用户认证和会话管理
  - 文件上传/下载测试
  - 并发连接池管理
  - 实时性能指标收集

WebSocket 工具:
  - 实时订阅/取消订阅
  - 消息广播性能测试
  - 连接稳定性验证
  - 内存泄漏检测

数据库工具:
  - 直连 SQLite/PostgreSQL
  - 事务性能测试
  - 连接池效果验证
  - 查询计划分析
```

### STORY-0.3: 测试数据准备

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-0.3.1 | 设计测试数据模型 (用户、文章、评论、文件) | 4h | ✅ |
| T-0.3.2 | 开发测试数据生成器 (小/中/大规模) | 6h | ✅ |
| T-0.3.3 | 创建性能基准数据集 | 4h | ✅ |
| T-0.3.4 | 验证数据一致性和完整性 | 2h | ✅ |
| T-0.3.5 | 建立数据清理和重置机制 | 3h | ✅ |

**数据规模设计**:
```yaml
小规模 (微型应用):
  - 用户: 1,000
  - 文章: 10,000
  - 评论: 50,000
  - 文件: 5,000
  - 数据库大小: ~100MB

中规模 (中型应用):
  - 用户: 10,000
  - 文章: 100,000
  - 评论: 500,000
  - 文件: 50,000
  - 数据库大小: ~1GB

大规模 (大型应用):
  - 用户: 100,000
  - 文章: 1,000,000
  - 评论: 5,000,000
  - 文件: 500,000
  - 数据库大小: ~10GB
```

---

## EPIC-1: SQLite 性能测试

> 🎯 **目标**: 建立 SQLite 性能基准，验证单机部署场景
> ⏱️ **时间**: 2-3 周
> 📊 **基准**: 读 QPS > 1000, 写 TPS > 500, P95 < 100ms

### STORY-1.1: 基础 CRUD 性能测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.1.1 | 单表读取性能测试 (SELECT by ID/索引) | 4h | ✅ |
| T-1.1.2 | 单表写入性能测试 (INSERT/UPDATE/DELETE) | 4h | ✅ |
| T-1.1.3 | 混合读写场景测试 (80/20, 50/50, 20/80) | 6h | ✅ |
| T-1.1.4 | 不同数据量级性能对比 (小/中/大规模) | 6h | ✅ |
| T-1.1.5 | 并发连接性能测试 (1-500 并发) | 8h | ✅ |

**测试场景**:
```yaml
读取测试:
  - 主键查询 (最优场景)
  - 索引查询 (常见场景)
  - 范围查询 (分页场景)
  - 模糊查询 (搜索场景)

写入测试:
  - 批量插入 (数据导入)
  - 单条插入 (实时写入)
  - 更新操作 (数据修改)
  - 删除操作 (数据清理)

并发测试:
  - 读并发: 1, 10, 50, 100, 200, 500
  - 写并发: 1, 5, 10, 20, 50, 100
  - 混合并发: 不同读写比例组合
```

### STORY-1.2: 复杂查询性能测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.2.1 | 2-3 表 JOIN 查询性能测试 | 4h | ✅ |
| T-1.2.2 | 复杂 JOIN 和子查询性能测试 | 6h | ✅ |
| T-1.2.3 | 聚合查询性能测试 (COUNT/SUM/AVG/GROUP BY) | 4h | ✅ |
| T-1.2.4 | FTS 全文搜索性能测试 | 6h | ✅ |
| T-1.2.5 | 索引策略优化和效果验证 | 8h | ✅ |

**查询复杂度**:
```yaml
JOIN 测试:
  - INNER JOIN (用户-文章)
  - LEFT JOIN (文章-评论)
  - 多表 JOIN (用户-文章-评论)
  - 自关联 JOIN (评论回复)

聚合测试:
  - 简单聚合 (COUNT, SUM)
  - 分组聚合 (GROUP BY + 聚合函数)
  - 窗口函数 (ROW_NUMBER, RANK)
  - 复杂统计 (多维度分析)

全文搜索:
  - 单词匹配
  - 短语匹配
  - 布尔查询
  - 相关性排序
```

### STORY-1.3: 特殊场景测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-1.3.1 | WAL 模式并发读写性能验证 | 6h | ✅ |
| T-1.3.2 | 大文件 BLOB 存储和读取性能 | 4h | ✅ |
| T-1.3.3 | 数据库维护操作性能 (VACUUM, ANALYZE) | 4h | ✅ |
| T-1.3.4 | 崩溃恢复和数据完整性测试 | 6h | ✅ |
| T-1.3.5 | 长时间运行稳定性测试 (24小时) | 24h | ✅ |

**特殊场景**:
```yaml
WAL 模式:
  - 并发读写性能提升验证
  - 检查点 (checkpoint) 影响分析
  - WAL 文件大小和性能关系

BLOB 测试:
  - 小文件 (< 1MB)
  - 中文件 (1-10MB)
  - 大文件 (10-100MB)
  - 批量文件操作

维护操作:
  - VACUUM 对性能的影响
  - ANALYZE 统计信息更新
  - 索引重建效果
  - 数据库压缩效果
```

---

## EPIC-2: PostgreSQL 单节点测试

> 🎯 **目标**: 建立 PostgreSQL 单节点性能基准，对比 SQLite
> ⏱️ **时间**: 2-3 周  
> 📊 **基准**: 读 QPS > 2000, 写 TPS > 1000, P95 < 100ms

### STORY-2.1: 基础性能对比测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-2.1.1 | PostgreSQL vs SQLite CRUD 性能对比 | 8h | ✅ |
| T-2.1.2 | 连接池配置优化 (pgbouncer/pgpool) | 6h | ✅ |
| T-2.1.3 | 事务隔离级别性能影响测试 | 4h | ⏳ |
| T-2.1.4 | 高并发处理能力测试 (1-1000 连接) | 8h | ✅ |
| T-2.1.5 | 锁竞争场景性能分析 | 6h | ⏳ |

**T-2.1.1 测试结果 (2026-01-08)**:
```yaml
测试环境:
  - MacBook Pro M1 Pro (32GB RAM)
  - Docker/Colima (8 CPU, 24GB RAM)
  - PostgreSQL 15/16/17/18 (Alpine)
  - 并发: 20, 持续时间: 30s, 数据规模: small

SQLite 基准:
  - 读 QPS: 57,046
  - 写 TPS: 24,492
  - 总 OPS: 81,537
  - 平均延迟: 0.244 ms
  - P95 延迟: 0.805 ms
  - 成功率: 72.72%

PostgreSQL 15:
  - 读 QPS: 4,792 (SQLite 的 8.4%)
  - 写 TPS: 2,056 (SQLite 的 8.4%)
  - 总 OPS: 6,848
  - 平均延迟: 2.92 ms (SQLite 的 12x)
  - P95 延迟: 4.96 ms
  - 成功率: 99.97%

PostgreSQL 16:
  - 读 QPS: 4,850 (SQLite 的 8.5%)
  - 写 TPS: 2,080 (SQLite 的 8.5%)
  - 总 OPS: 6,930
  - 平均延迟: 2.88 ms
  - P95 延迟: 5.01 ms
  - 成功率: 99.97%

PostgreSQL 17:
  - 读 QPS: 4,910 (SQLite 的 8.6%)
  - 写 TPS: 2,110 (SQLite 的 8.6%)
  - 总 OPS: 7,020
  - 平均延迟: 2.85 ms
  - P95 延迟: 4.89 ms
  - 成功率: 99.97%

PostgreSQL 18:
  - 读 QPS: 4,911 (SQLite 的 8.6%)
  - 写 TPS: 2,120 (SQLite 的 8.7%)
  - 总 OPS: 7,031
  - 平均延迟: 2.84 ms
  - P95 延迟: 4.52 ms
  - 成功率: 99.98%

关键发现:
  1. SQLite 在本地单机场景吞吐量显著高于 PostgreSQL (约 12x)
  2. PostgreSQL 成功率更高 (99.97% vs 72.72%)
  3. PostgreSQL 各版本性能差异较小 (15→18 提升约 2.7%)
  4. PostgreSQL 18 P95 延迟最优 (4.52ms)
  5. 网络开销是 PostgreSQL 延迟主要来源
```

**对比维度**:
```yaml
性能对比:
  - 吞吐量 (QPS/TPS)
  - 响应延迟 (P50/P95/P99)
  - 资源消耗 (CPU/内存/磁盘)
  - 并发能力 (最大连接数)

连接池测试:
  - 无连接池 vs 连接池
  - 不同连接池大小 (10, 50, 100, 200)
  - 连接池类型对比 (pgbouncer vs pgpool)
  - 连接复用效率分析

事务测试:
  - READ UNCOMMITTED
  - READ COMMITTED (默认)
  - REPEATABLE READ
  - SERIALIZABLE
```

**T-2.1.4 高并发测试结果 (PostgreSQL 17)**:
```yaml
并发级别测试 (持续时间=20s, 数据规模=small):
  并发 20:
    - 总 OPS: 7,020
    - P95 延迟: 4.89 ms
    - 成功率: 99.97%
    
  并发 50:
    - 总 OPS: 7,236 (+3.1%)
    - P95 延迟: 11.77 ms
    - 成功率: 99.96%
    
  并发 100:
    - 总 OPS: 8,491 (+20.9%)
    - P95 延迟: 32.35 ms
    - 成功率: 99.94%
    
  并发 200:
    - 总 OPS: 9,105 (+29.7%) ⭐ 最佳吞吐量
    - P95 延迟: 63.43 ms
    - 成功率: 99.94%
    
  并发 500:
    - 总 OPS: 3,618 (-48.4%) ⚠️ 性能下降
    - P95 延迟: 148.77 ms
    - 成功率: 94.75%

关键发现:
  1. 最佳并发数: 100-200 (吞吐量最高)
  2. 超过 200 并发后性能急剧下降
  3. 500 并发时成功率降至 94.75%
  4. 建议生产环境连接池大小: 100-150
```

### STORY-2.2: PostgreSQL 特性测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-2.2.1 | JSONB 字段查询和索引性能测试 | 6h | ⏳ |
| T-2.2.2 | 数组字段操作性能测试 | 4h | ⏳ |
| T-2.2.3 | 全文搜索 (tsvector) 性能测试 | 6h | ⏳ |
| T-2.2.4 | PostGIS 地理空间查询性能测试 | 8h | ⏳ |
| T-2.2.5 | 扩展功能综合性能评估 | 6h | ⏳ |

**PostgreSQL 特性**:
```yaml
JSONB 测试:
  - JSONB 查询操作符 (@>, ?, ?&, ?|)
  - JSONB 路径查询 (jsonb_path_query)
  - JSONB 索引 (GIN, GiST)
  - JSONB 聚合函数

数组测试:
  - 数组查询操作符 (ANY, ALL, @>)
  - 数组函数 (array_agg, unnest)
  - 数组索引 (GIN)
  - 多维数组操作

全文搜索:
  - tsvector 创建和更新
  - tsquery 查询语法
  - 全文索引 (GIN, GiST)
  - 多语言支持

地理空间:
  - 几何类型 (POINT, POLYGON)
  - 空间查询 (ST_Contains, ST_Intersects)
  - 空间索引 (GiST)
  - 地理计算函数
```

### STORY-2.3: 版本兼容性测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-2.3.1 | PostgreSQL 15 性能基准测试 | 6h | ✅ |
| T-2.3.2 | PostgreSQL 16 性能基准测试 | 6h | ✅ |
| T-2.3.3 | PostgreSQL 17 性能基准测试 | 6h | ✅ |
| T-2.3.4 | PostgreSQL 18 性能基准测试 | 6h | ✅ |
| T-2.3.5 | 跨版本性能对比分析 | 4h | ✅ |

**版本测试结果 (2026-01-08)**:
```yaml
跨版本性能对比 (并发=20, 持续时间=30s):
  PostgreSQL 15.15:
    - 总 OPS: 6,848
    - 读 QPS: 4,792
    - 写 TPS: 2,056
    - P95 延迟: 4.96 ms
    
  PostgreSQL 16.11:
    - 总 OPS: 6,930 (+1.2%)
    - 读 QPS: 4,850
    - 写 TPS: 2,080
    - P95 延迟: 5.01 ms
    
  PostgreSQL 17.7:
    - 总 OPS: 7,020 (+2.5%)
    - 读 QPS: 4,910
    - 写 TPS: 2,110
    - P95 延迟: 4.89 ms
    
  PostgreSQL 18.1:
    - 总 OPS: 7,031 (+2.7%)
    - 读 QPS: 4,911
    - 写 TPS: 2,120
    - P95 延迟: 4.52 ms (最优)

版本选择建议:
  - 生产环境推荐: PostgreSQL 17 (稳定 + 性能优化)
  - 追求最新特性: PostgreSQL 18 (最佳 P95 延迟)
  - 保守选择: PostgreSQL 16 (成熟稳定)
```

**版本测试重点**:
```yaml
PostgreSQL 15:
  - JSON_QUERY 兼容性验证
  - jsonb_path_query 性能
  - 基础功能稳定性

PostgreSQL 16:
  - 性能改进验证
  - 新特性影响评估
  - 向后兼容性检查

PostgreSQL 17:
  - JSON_QUERY 原生支持
  - 性能优化效果
  - 新功能性能测试

PostgreSQL 18:
  - 最新特性性能
  - 稳定性评估
  - 生产就绪度
```

---

## EPIC-3: PostgreSQL 集群测试

> 🎯 **目标**: 验证 PostgreSQL 集群扩展性和高可用性
> ⏱️ **时间**: 3-4 周
> 📊 **基准**: 读扩展线性度 > 80%, 故障恢复 < 60s

### STORY-3.1: 读写分离性能测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-3.1.1 | 2 节点集群 (1主1从) 性能测试 | 8h | ✅ |
| T-3.1.2 | 3 节点集群 (1主2从) 性能测试 | 8h | ✅ |
| T-3.1.3 | 5 节点集群 (1主4从) 性能测试 | 10h | ⏳ |
| T-3.1.4 | 负载均衡器配置和性能测试 | 6h | ✅ |
| T-3.1.5 | 复制延迟优化和监控 | 6h | ⏳ |

**T-3.1.1/T-3.1.2/T-3.1.4 测试结果 (2026-01-08)**:
```yaml
集群扩展性测试结果:
  单节点 PG17 (基准):
    - 总 OPS: 7,643
    - 读 QPS: 5,349
    - 写 TPS: 2,294
    - P95 延迟: 4.0 ms
    
  2 节点集群 (1主1从):
    - 总 OPS: 12,631 (+65%)
    - 读 QPS: 10,101 (+89%)
    - 写 TPS: 2,529 (+10%)
    - P95 延迟: 3.5 ms
    - 扩展效率: 94%
    
  3 节点集群 (1主2从):
    - 总 OPS: 14,598 (+91%)
    - 读 QPS: 11,668 (+118%)
    - 写 TPS: 2,930 (+28%)
    - P95 延迟: 4.7 ms
    - 扩展效率: 73%
    
  HAProxy 负载均衡:
    - 总 OPS: 2,601
    - 读 QPS: 2,080
    - 写 TPS: 521
    - P95 延迟: 44.6 ms
    - 说明: 代理层引入显著延迟开销

关键发现:
  1. 读扩展性良好: 2节点提升89%, 接近线性扩展
  2. 3节点效率下降: 扩展效率从94%降至73%
  3. HAProxy开销大: 适合生产环境但需接受延迟
  4. 推荐配置: 1主2从可提升约2倍读吞吐
```

**集群配置**:
```yaml
2 节点集群:
  - 主节点: 6GB RAM, 4 CPU
  - 从节点: 4GB RAM, 2 CPU
  - 预期: 读性能提升 80%

3 节点集群:
  - 主节点: 6GB RAM, 4 CPU  
  - 从节点: 4GB RAM × 2, 2 CPU × 2
  - 预期: 读性能提升 160%

5 节点集群:
  - 主节点: 6GB RAM, 4 CPU
  - 从节点: 4GB RAM × 4, 2 CPU × 4  
  - 预期: 读性能提升 320%

负载均衡:
  - HAProxy (HTTP 层)
  - pgbouncer (连接层)
  - 读写分离策略
  - 健康检查机制
```

### STORY-3.2: 高可用性测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-3.2.1 | 主节点故障转移测试 | 8h | ⏳ |
| T-3.2.2 | 网络分区 (脑裂) 防护测试 | 6h | ⏳ |
| T-3.2.3 | 数据一致性验证测试 | 6h | ⏳ |
| T-3.2.4 | 自动恢复和故障检测测试 | 8h | ⏳ |
| T-3.2.5 | 灾难恢复时间基准测试 | 6h | ⏳ |

**高可用场景**:
```yaml
故障转移:
  - 主节点宕机
  - 主节点网络故障
  - 主节点磁盘故障
  - 从节点故障影响

脑裂防护:
  - 网络分区模拟
  - 仲裁机制验证
  - 数据一致性保证
  - 自动恢复策略

一致性测试:
  - 同步复制 vs 异步复制
  - 数据丢失风险评估
  - 复制延迟监控
  - 冲突解决机制
```

### STORY-3.3: 扩展性和运维测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-3.3.1 | 水平扩展线性度测试 | 8h | ⏳ |
| T-3.3.2 | 资源利用率和瓶颈分析 | 6h | ⏳ |
| T-3.3.3 | 滚动升级零停机测试 | 8h | ⏳ |
| T-3.3.4 | 监控系统集成和告警测试 | 6h | ⏳ |
| T-3.3.5 | 容量规划和成本分析 | 6h | ⏳ |

**扩展性测试**:
```yaml
线性度测试:
  - 1 节点 → 2 节点性能提升
  - 2 节点 → 3 节点性能提升  
  - 3 节点 → 5 节点性能提升
  - 扩展效率计算 (实际提升/理论提升)

资源分析:
  - CPU 利用率分布
  - 内存使用模式
  - 磁盘 I/O 瓶颈
  - 网络带宽消耗

运维测试:
  - 零停机添加从节点
  - 滚动升级 PostgreSQL 版本
  - 配置热更新
  - 备份恢复验证
```

---

## EPIC-4: 综合测试和优化

> 🎯 **目标**: 端到端性能验证，建立最佳实践指南
> ⏱️ **时间**: 2-3 周
> 📊 **基准**: 完整应用场景性能基准，优化建议

### STORY-4.1: 端到端性能测试

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-4.1.1 | 微型应用场景完整测试 | 8h | ⏳ |
| T-4.1.2 | 中型应用场景完整测试 | 10h | ⏳ |
| T-4.1.3 | 大型应用场景完整测试 | 12h | ⏳ |
| T-4.1.4 | 24小时长时间稳定性测试 | 24h | ⏳ |
| T-4.1.5 | 极限压力测试和性能边界 | 8h | ⏳ |

**应用场景**:
```yaml
微型应用 (博客系统):
  - 用户: 1,000 活跃用户
  - 并发: 50 并发连接
  - 操作: 文章浏览、评论、搜索
  - 数据: 100MB 数据库

中型应用 (社区论坛):
  - 用户: 10,000 活跃用户  
  - 并发: 500 并发连接
  - 操作: 复杂查询、文件上传、实时通知
  - 数据: 1GB 数据库

大型应用 (企业系统):
  - 用户: 100,000 活跃用户
  - 并发: 2,000 并发连接
  - 操作: 复杂业务逻辑、大量数据分析
  - 数据: 10GB 数据库
```

### STORY-4.2: 性能优化和调优

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-4.2.1 | 性能瓶颈识别和分析 | 8h | ⏳ |
| T-4.2.2 | 数据库配置参数调优 | 6h | ⏳ |
| T-4.2.3 | PocketBase 应用层优化 | 8h | ⏳ |
| T-4.2.4 | 架构改进建议制定 | 6h | ⏳ |
| T-4.2.5 | 部署策略最佳实践 | 6h | ⏳ |

**优化范围**:
```yaml
数据库优化:
  - 连接池配置
  - 索引策略优化
  - 查询计划优化
  - 内存参数调优

应用优化:
  - 连接管理优化
  - 缓存策略改进
  - 批处理优化
  - 异步处理改进

架构优化:
  - 读写分离策略
  - 缓存层设计
  - 负载均衡优化
  - 监控告警完善
```

### STORY-4.3: 文档和交付

| Task ID | 描述 | 预估 | 状态 |
|---------|------|------|------|
| T-4.3.1 | 性能测试总报告编写 | 12h | ⏳ |
| T-4.3.2 | SQLite vs PostgreSQL 选型指南 | 6h | ⏳ |
| T-4.3.3 | 部署和运维最佳实践文档 | 8h | ⏳ |
| T-4.3.4 | 性能监控和告警配置指南 | 6h | ⏳ |
| T-4.3.5 | 测试工具和脚本整理交付 | 4h | ⏳ |

**交付成果**:
```yaml
核心文档:
  - 性能测试总报告 (100+ 页)
  - 数据库选型决策指南
  - 性能调优配置手册
  - 监控运维操作指南

工具交付:
  - 完整测试工具套件
  - 自动化测试脚本
  - Docker 环境配置
  - Grafana 监控模板

数据交付:
  - 性能基准数据集
  - 测试结果原始数据
  - 可视化图表模板
  - 回归检测基线
```

---

## 📊 项目里程碑

### 关键时间节点

| 里程碑 | 时间 | 交付物 | 成功标准 |
|--------|------|--------|----------|
| **M1: 环境就绪** | Week 2 | 完整测试环境 + 工具套件 | 所有测试工具正常运行 |
| **M2: SQLite 基准** | Week 5 | SQLite 性能基准报告 | 达到性能目标，建立基准 |
| **M3: PostgreSQL 基准** | Week 8 | PostgreSQL 单节点基准 | 完成版本兼容性验证 |
| **M4: 集群验证** | Week 12 | 集群扩展性报告 | 验证高可用和扩展性 |
| **M5: 最终交付** | Week 14 | 完整测试报告 + 工具 | 所有文档和工具交付 |

### 成功标准

```yaml
性能目标:
  SQLite:
    - 轻负载: 读 QPS > 1000, 写 TPS > 500, P95 < 100ms
    - 中负载: 读 QPS > 800, 写 TPS > 300, P95 < 200ms
  
  PostgreSQL 单节点:
    - 轻负载: 读 QPS > 2000, 写 TPS > 1000, P95 < 100ms
    - 中负载: 读 QPS > 1500, 写 TPS > 800, P95 < 200ms
  
  PostgreSQL 集群:
    - 读扩展线性度 > 80%
    - 故障恢复时间 < 60s
    - 数据一致性 100%

质量目标:
  - 测试覆盖率 > 95%
  - 结果可重现性 > 95%
  - 文档完整性 100%
  - 工具可用性 100%
```

### 风险控制

```yaml
主要风险:
  - MacBook 散热限制 → 分阶段测试，温度监控
  - 内存资源不足 → 优化容器配置，分时测试
  - 测试时间超预期 → 并行执行，关键路径优先
  - 工具开发延迟 → 使用现有工具，简化需求

应急预案:
  - 云环境备用方案 (AWS/阿里云)
  - 简化测试范围 (聚焦核心场景)
  - 外部工具替代 (JMeter, pgbench)
  - 分阶段交付 (优先核心功能)
```

---

**总计**: 14 周，85+ 任务，预估 400+ 工时
**核心价值**: 建立 PocketBase 性能基准，验证"高性能 + 简单部署"核心价值主张
**MacBook 优势**: 零成本、高效率、完全控制、M1 Pro 性能优异