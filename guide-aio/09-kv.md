# KV 存储

## 概述

类 Redis 的键值存储，支持 SQLite 和 PostgreSQL，采用两级缓存架构：

- **L1**: 进程内缓存（5s TTL）
- **L2**: 数据库持久化

## 接口定义

```go
type KVStore interface {
    // 基础操作
    Get(key string) (any, error)
    Set(key string, value any) error
    SetEx(key string, value any, ttl time.Duration) error
    Delete(key string) error
    Exists(key string) (bool, error)
    
    // TTL 操作
    TTL(key string) (time.Duration, error)
    Expire(key string, ttl time.Duration) error
    
    // 计数器
    Incr(key string) (int64, error)
    IncrBy(key string, delta int64) (int64, error)
    Decr(key string) (int64, error)
    
    // Hash 操作
    HSet(key, field string, value any) error
    HGet(key, field string) (any, error)
    HGetAll(key string) (map[string]any, error)
    HDel(key string, fields ...string) error
    HIncrBy(key, field string, delta int64) (int64, error)
    
    // 分布式锁
    Lock(key string, ttl time.Duration) (bool, error)
    Unlock(key string) error
    
    // 批量操作
    MSet(pairs map[string]any) error
    MGet(keys ...string) (map[string]any, error)
    Keys(pattern string) ([]string, error)
}

// 常量
const (
    KVMaxKeyLength   = 256
    KVMaxValueSize   = 1 << 20  // 1MB
)
```

## 使用示例

```go
kv := app.KV()

// 基础操作
kv.Set("user:1:name", "John")
kv.SetEx("session:abc", data, 30*time.Minute)
value, _ := kv.Get("user:1:name")
kv.Delete("user:1:name")

// 计数器
count, _ := kv.Incr("page:views")
count, _ := kv.IncrBy("user:points", 10)

// 分布式锁
acquired, _ := kv.Lock("resource:lock", 30*time.Second)
if acquired {
    defer kv.Unlock("resource:lock")
    // 临界区代码
}

// Hash 操作
kv.HSet("user:1", "name", "John")
kv.HSet("user:1", "age", 30)
all, _ := kv.HGetAll("user:1")
```

## API 端点

| 方法 | 路径 | 描述 |
|------|------|------|
| POST | `/api/kv/set` | 设置键值 |
| GET | `/api/kv/get?key=xxx` | 获取值 |
| DELETE | `/api/kv/delete?key=xxx` | 删除键 |
| POST | `/api/kv/incr` | 递增 |
| POST | `/api/kv/lock` | 获取分布式锁 |
| POST | `/api/kv/unlock` | 释放锁 |
| POST | `/api/kv/hset` | Hash 设置 |
| GET | `/api/kv/hgetall` | Hash 获取全部 |
| POST | `/api/kv/mset` | 批量设置 |
| POST | `/api/kv/mget` | 批量获取 |
